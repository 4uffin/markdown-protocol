<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDP Protocol Client Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a terminal-like appearance */
        body {
            font-family: 'Inter', monospace;
            background-color: #1a1b26; /* Dark background */
            color: #c0caf5; /* Light text */
        }
        .client-window {
            border: 2px solid #7aa2f7; /* Blue border */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .mdp-content h1, .mdp-content h2, .mdp-content h3 {
            color: #a9b6fb; /* Accent color for headings */
            border-bottom: 1px solid #414868;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .mdp-content h1 { font-size: 2.25rem; }
        .mdp-content h2 { font-size: 1.75rem; }
        .mdp-content a {
            color: #9ece6a; /* Green for links */
            text-decoration: underline;
            transition: color 0.1s;
        }
        .mdp-content a:hover {
            color: #739d4b;
        }
        .mdp-content code {
            background-color: #24283b;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .mdp-content pre {
            background-color: #24283b;
            padding: 1rem;
            overflow-x: auto;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .mdp-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            padding-left: 0.5rem;
        }
        /* Custom styling for rendered images to make them fit the theme */
        .mdp-content img {
            max-width: 100%;
            height: auto;
            margin: 1rem auto;
            display: block;
            border: 1px solid #7aa2f7; /* Blue border for the theme */
            border-radius: 8px;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-[#7aa2f7]">
            Markdown Protocol (MDP) Client Simulator
        </h1>

        <!-- Address Bar / Navigation -->
        <div class="flex space-x-2 mb-4">
            <button id="backButton" aria-label="Back" title="Go Back in MDP History" class="px-4 py-2.5 bg-[#414868] hover:bg-[#545c85] text-white rounded-lg shadow-md transition duration-150" disabled>
                &larr;
            </button>
            <button id="forwardButton" aria-label="Forward" title="Go Forward in MDP History" class="px-4 py-2.5 bg-[#414868] hover:bg-[#545c85] text-white rounded-lg shadow-md transition duration-150" disabled>
                &rarr;
            </button>
            <input id="urlInput" title="Enter a markdown:// URI or full URL to navigate" type="text" class="flex-grow px-3 py-2.5 rounded-lg bg-[#24283b] text-[#c0caf5] border border-[#7aa2f7] focus:border-[#a9b6fb] focus:ring-0" value="markdown://home">
            <button id="goButton" title="Navigate to the entered URI" class="px-4 py-2.5 bg-[#7aa2f7] hover:bg-[#a9b6fb] text-black font-semibold rounded-lg shadow-md transition duration-150">
                GO
            </button>
        </div>

        <!-- Simulated Client Window -->
        <div class="client-window p-6 rounded-xl bg-[#1f2335] min-h-[500px]">
            <div id="loadingIndicator" class="text-center py-10 hidden">
                <p>Loading MDP content...</p>
            </div>
            <div id="contentDisplay" class="mdp-content">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Global State and Constants ---
        const urlInput = document.getElementById('urlInput');
        const goButton = document.getElementById('goButton');
        const backButton = document.getElementById('backButton');
        const forwardButton = document.getElementById('forwardButton');
        const contentDisplay = document.getElementById('contentDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Custom History Tracking for accurate Back/Forward button state
        let mdpHistory = ['markdown://home'];
        let mdpHistoryIndex = 0;
        
        /**
         * Returns the current local time in 12-hour format.
         * @returns {string} Formatted time string.
         */
        function getFormattedTime() {
            const now = new Date();
            return now.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // Simple database mapping MDP URIs to raw Markdown content
        const MDP_CONTENT_DB = {
            'markdown://home': `
# Welcome to MDP: Pure Content Transfer
The Markdown Protocol (MDP) is a conceptual protocol **inspired by HTTP's request/response model and the Gemini protocol's minimalist philosophy.** It is designed for maximum simplicity and efficient content sharing.

---

## Core Philosophy (Inspired by Gemini)
The server's only role is to provide the content, and the **Client** (this application) handles **all** styling, layout, and presentation. This decouples content from its appearance completely.

### Navigation (Inspired by HTTP)
* **Internal:** Links starting with \`markdown://\` navigate within the MDP ecosystem.
* **External:** Links starting with \`http://\` or \`https://\` are external and handled by the standard browser engine.

[Go to the Details Document](markdown://docs/details)
[Read the FAQ](markdown://docs/faq)
[Check Client Compliance](markdown://client/test)

## Search the MDP Ecosystem (Client Demonstration)
This client supports passing query strings. Try searching for something here:

[Search for 'Protocol'](markdown://search?q=Protocol)
[Search for 'Security'](markdown://search?q=Security)

## Client Settings (Simulated)
This client is using a custom, high-contrast, terminal-inspired theme. This style is not dictated by the server.

[Visit an external site](https://www.google.com) (Will open in a new tab/window)
`,
            'markdown://docs/details': `
# Document Details and Syntax Test

## Lists and Structure
Here are some Markdown features this client supports:

* Unordered lists are easy to read.
* They maintain a high contrast style.
* This structure promotes rapid information consumption.

## Code Block Example
Code blocks are essential for sharing technical data.

\`\`\`javascript
// This is a typical JavaScript code block.
function simpleMDPFetch(uri) {
    if (uri === 'markdown://404') {
        return '# Error 404: Not Found';
    }
    return MDP_CONTENT_DB[uri];
}
\`\`\`

## Text Formatting
A paragraph with **bold text**, *italic emphasis*, and a little \`inline code\`. The entire page's look is defined by your client.

[Back to Technical Spec](markdown://technical/spec)
[Back to Home](markdown://home)
`,
            'markdown://docs/faq': `
# Frequently Asked Questions

---

## What is MDP?
MDP stands for Markdown Protocol. It is a proposed internet protocol designed to simplify web content consumption by serving pure Markdown text instead of complex HTML. It's inspired by HTTP and Gemini.

## Why use Markdown?
Markdown is a lightweight markup language that emphasizes content structure over visual design. By relying on Markdown, MDP eliminates the need for CSS and JavaScript, leading to faster loading times and better security.

## Who controls the styling?
The styling (fonts, colors, layout) is controlled entirely by the MDP Client (the "browser") and the user's local preferences. The server provides no styling information.

[Back to Home](markdown://home)
`,
            'markdown://technical/spec': `
# MDP Protocol Specification Draft 1.0 (Refined)

---

## 1. Request Structure
A client requests a resource using a URI with the \`markdown://\` scheme. The request is generally a simple GET operation.

## 2. Server Response Structure
The server MUST precede the content body with a status header indicating the transaction outcome. The Content-Type MUST be \`text/markdown\`.

## 3. MDP Status Codes (Simulated)
MDP uses simple, two-digit status codes to communicate transaction results back to the client. The client is responsible for interpreting and handling these results (e.g., automatically following a redirect or displaying an error page).

* **20 OK:** The request was successful, and the content follows immediately.
* **30 Redirect:** The requested resource has moved. The content body may contain a new URI, or the client may simply display a static message.
* **40 Not Found:** The requested URI does not correspond to any resource on the server.
* **50 Server Error:** The server encountered an internal problem and could not fulfill the request.

## 4. Allowed Content Types
Only **CommonMark Markdown** is permitted in the document body. Image links via \`http://\` or \`https://\` are allowed to embed media, but these must be treated as external resources.

## 5. Forbidden Elements and Security Rationale
The MDP strictly forbids certain elements to guarantee minimalism, security, and client autonomy:

* **Scripting (JavaScript, WebAssembly):** FORBIDDEN. This is the single most important security measure. By prohibiting executable code, MDP **eliminates the risk** of XSS attacks, tracking, and malware injection.
* **External Styling (CSS/Inline Styling):** FORBIDDEN. The client's local theme (like the dark, terminal-style theme you're using) is **unalterable** by the server. This ensures a consistent, accessible user experience and prevents "style hijacking."
* **Proprietary Markup or Binary Data:** FORBIDDEN. Content must remain pure, readable Markdown.

[Back to Details](markdown://docs/details)
[Back to Home](markdown://home)
`,
            'markdown://data/status': `
# Client Status Information

This page demonstrates client-side content processing. The server sent the placeholder, and the client (your browser) replaced it with live data.

* **Current Client Time (Local):** [CLIENT_INFO:TIMESTAMP]
* **Client User Agent:** The client is responsible for interpreting the content, not the server.
* **Protocol Status:** Operational
* **Current MDP URI:** \`markdown://data/status\`

[Back to Home](markdown://home)
`,
            'markdown://search': `
# Search Results

You requested a search for: **[CLIENT_INFO:SEARCH_TERM]**

---

This is the static content returned by the server for \`markdown://search\`. The MDP client interpreted the URI's query parameters (\`?q=...\`) and dynamically inserted the term above.

## Simulated Results
* If the search term was "Protocol", result 1.
* If the search term was "Security", result 2.

[Back to Home](markdown://home)
`,
            'markdown://client/test': `
# Client Compliance Test: Supported Markdown Features

---

## 1. Headings
This client supports H1, H2, and H3 elements.

### Heading Level 3
All headings are clearly separated and styled by the client's local theme.

## 2. Text Emphasis and Inline Code
This is a standard paragraph to test *italic text* and **bold (strong) text**. 
The most common way to display technical syntax is using \`inline code snippets\` within sentences.

## 3. Lists
Unordered lists should render with clear bullet points.

* First item in the list
* Second item requires *emphasis*
* Third item uses **bolding** and includes a link: [Back to Home](markdown://home)

## 4. Code Blocks
Syntax highlighting is not the server's concern, but the structure of the code block itself must be maintained by the client.

\`\`\`python
# Python code example for Fibonacci Sequence
def fibonacci(n):
    a, b = 0, 1
    for _ in range(n):
        yield a
        a, b = b, a + b

# Using the function
print("Generating 5 numbers:")
for val in fibonacci(5):
    print(val)
\`\`\`

## 5. Horizontal Rule
The horizontal rule (HR) element should provide a clear visual separation between sections, like the one below this text.

---

## 6. Links (Internal and External)
The client must handle both MDP links and standard external links correctly.

* Internal Navigation: [Go to Technical Specification](markdown://technical/spec)
* External Navigation (Opens in new tab): [Check out Google](https://www.google.com)

## 7. Images (External Resources)
The client fetches and displays external images referenced in the MDP document. The client controls the styling (e.g., border, max-width).

![Placeholder image for the MDP concept](https://placehold.co/600x200/414868/c0caf5?text=MDP+Image+Placeholder)

[Back to Home](markdown://home)
`,
            'markdown://404': `
# Error: MDP Resource Not Found
The MDP document you requested could not be located on the simulated server.

[Back to Home](markdown://home)
`
        };

        // --- Core MDP Functions ---

        /**
         * Simulates the MDP server fetching content.
         * In a real implementation, this would be a network fetch call.
         * @param {string} uri The markdown:// URI requested.
         * @returns {Promise<string>} The raw Markdown text.
         */
        async function fetchMDPContent(uri) {
            // Simulate network latency
            await new Promise(resolve => setTimeout(resolve, 300));

            const content = MDP_CONTENT_DB[uri] || MDP_CONTENT_DB['markdown://404'];
            return content;
        }

        /**
         * Simple Markdown-to-HTML Renderer.
         * This embodies the client's built-in rendering logic.
         * NOTE: This is a highly simplified parser and ignores many complexities.
         * @param {string} markdownText
         * @param {string} [searchTerm=''] - Optional term parsed from the URI query string.
         * @returns {string} The rendered HTML string.
         */
        function renderMarkdown(markdownText, searchTerm = '') {
            // --- Client-Side Dynamic Replacements ---
            // 1. Replace the timestamp placeholder with the client's current local time.
            markdownText = markdownText.replace(/\[CLIENT_INFO:TIMESTAMP\]/g, getFormattedTime());
            
            // 2. Replace the search term placeholder with the parsed query.
            const termToDisplay = searchTerm ? decodeURIComponent(searchTerm) : 'No query term provided.';
            markdownText = markdownText.replace(/\[CLIENT_INFO:SEARCH_TERM\]/g, termToDisplay);
            // ---------------------------------------------
            
            let html = markdownText
                // Basic HTML escaping (important for safety)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // 1. Image References (must be done before link replacement)
            // Regex: ! [ Alt Text ] ( URL )
            // Must use a permissive regex here since the content is already escaped by the client (replace: &amp;lt; with < etc.)
            const imageRegex = /!\[(.*?)\]\((.*?)\)/g;
            html = html.replace(imageRegex, (match, altText, url) => {
                // We MUST unescape the altText and url before using them in the HTML tag
                const cleanAlt = altText.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                const cleanUrl = url.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                // The client applies styling via CSS to ensure the image fits the theme/layout
                return `<img src="${cleanUrl}" alt="${cleanAlt}" onerror="this.onerror=null; this.src='https://placehold.co/400x150/ff0000/ffffff?text=Image+Load+Error';" />`;
            });

            // 2. Code Blocks (must be done before other replacements)
            // Revert escaped backticks for proper code block detection
            const codeBlockRegex = /```(\w+)\s*([\s\S]*?)```/g;
            html = html.replace(codeBlockRegex, (match, lang, code) => {
                // Unescape inner code content
                const cleanCode = code
                    .replace(/&amp;/g, '&')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>');
                return `<pre><code class="language-${lang}">${cleanCode.trim()}</code></pre>`;
            });

            // 3. Headings (H1, H2, H3)
            html = html.replace(/^###\s*(.*)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s*(.*)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s*(.*)$/gm, '<h1>$1</h1>');

            // 4. Horizontal Rule
            html = html.replace(/^\s*[-*]{3,}\s*$/gm, '<hr>');

            // 5. Links ([Text](URL))
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, (match, text, url) => {
                // Differentiate internal MDP links from external HTTP links
                const target = url.startsWith('http') ? '_blank' : '_self';
                // Note: using onclick for MDP links to hijack navigation
                if (url.startsWith('markdown://')) {
                    return `<a href="#" data-mdp-link="${url}" target="${target}">${text}</a>`;
                }
                return `<a href="${url}" target="${target}">${text}</a>`;
            });

            // 6. Lists (simple unordered)
            html = html.replace(/^\*\s*(.*)$/gm, '<li>$1</li>');
            html = html.replace(/^(<li>.*<\/li>(\s*<li>.*<\/li>)*)/gms, '<ul>$1</ul>');
            
            // 7. Inline formatting (Strong, Emphasis, Inline Code)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // **Bold**
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // *Italic* (simple form)
            html = html.replace(/`(.*?)`/g, '<code>$1</code>'); // `Code`

            // 8. Paragraphs and line breaks
            // Wrap remaining content in paragraphs if it's not already in a block element
            html = html.split('\n\n').map(p => {
                const trimmedP = p.trim();
                // Check if it's already a block element we've generated (h1-h3, ul, li, pre, hr, img, a, strong, em, code)
                if (trimmedP && !trimmedP.match(/<(\/?(h[1-3]|ul|li|pre|hr|img|strong|em|code)|!)/i)) {
                    return `<p>${trimmedP.replace(/\n/g, '<br>')}</p>`;
                }
                return trimmedP;
            }).join('');
            
            // Finally, clean up any stray newlines between block elements
            html = html.replace(/<\/p><p>/g, '</p>\n<p>');

            return html;
        }

        /**
         * Main function to handle MDP request and rendering.
         * @param {string} uri
         * @param {boolean} pushState Whether to update browser history.
         */
        async function navigateMDP(uri, pushState = true) {
            uri = uri.trim();
            
            // --- NEW: Parse URI and extract query term ---
            const parts = uri.split('?');
            const contentUri = parts[0];
            const queryString = parts.length > 1 ? parts[1] : '';

            // Extract search term from query string 'q='
            let searchTerm = '';
            if (queryString) {
                const params = new URLSearchParams(queryString);
                // We use 'q' as the standard search query parameter
                searchTerm = params.get('q') || '';
            }
            // ---------------------------------------------

            if (!contentUri.startsWith('markdown://')) {
                console.error('MDP client only handles markdown:// URIs.');
                return;
            }

            urlInput.value = uri;
            loadingIndicator.classList.remove('hidden');
            contentDisplay.innerHTML = '';
            
            try {
                // Fetch content using the base URI (the server doesn't care about the query)
                const rawMarkdown = await fetchMDPContent(contentUri);
                // Pass the extracted search term to renderMarkdown for dynamic content
                const renderedHtml = renderMarkdown(rawMarkdown, searchTerm);
                
                contentDisplay.innerHTML = renderedHtml;

                // Update browser history for back button support
                if (pushState) {
                    // Update our custom history tracker
                    if (mdpHistoryIndex < mdpHistory.length - 1) {
                        mdpHistory = mdpHistory.slice(0, mdpHistoryIndex + 1);
                    }
                    mdpHistory.push(uri);
                    mdpHistoryIndex = mdpHistory.length - 1;

                    // Push state to native browser history, only storing the URI in the hash
                    window.history.pushState(null, uri, `#${uri}`);
                }
            } catch (error) {
                console.error("MDP Navigation Error:", error);
                contentDisplay.innerHTML = `<h1 class="text-red-500">Navigation Error</h1><p>Could not retrieve MDP content for ${uri}.</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                updateHistoryButtons();
            }
        }

        /**
         * Handles history change from the user's *native* browser back/forward gestures.
         * We update our custom index to match the URL hash when this happens.
         */
        window.onpopstate = (event) => {
            const uriFromHash = window.location.hash ? window.location.hash.substring(1) : 'markdown://home';

            // Find the URI in our custom history array to sync the index
            const newIndex = mdpHistory.indexOf(uriFromHash);
            
            if (newIndex !== -1) {
                mdpHistoryIndex = newIndex;
            }
            
            navigateMDP(uriFromHash, false); // Render, but do not push a new state
        };

        /**
         * Updates the state of the back and forward buttons based on the custom history index.
         */
        function updateHistoryButtons() {
            // Back is disabled if index is 0 (at the beginning of history)
            backButton.disabled = mdpHistoryIndex <= 0;
            // Forward is disabled if index is the last element in the history array
            forwardButton.disabled = mdpHistoryIndex >= mdpHistory.length - 1;
        }

        // --- Event Listeners ---

        goButton.addEventListener('click', () => {
            navigateMDP(urlInput.value);
        });

        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                navigateMDP(urlInput.value);
            }
        });

        // Manual Back Button Handler
        backButton.addEventListener('click', () => {
            if (mdpHistoryIndex > 0) {
                mdpHistoryIndex--;
                const uri = mdpHistory[mdpHistoryIndex];
                navigateMDP(uri, false); // Render the page
                window.history.replaceState(null, uri, `#${uri}`); // Update URL hash without pushing new history
            }
        });

        // Manual Forward Button Handler
        forwardButton.addEventListener('click', () => {
            if (mdpHistoryIndex < mdpHistory.length - 1) {
                mdpHistoryIndex++;
                const uri = mdpHistory[mdpHistoryIndex];
                navigateMDP(uri, false); // Render the page
                window.history.replaceState(null, uri, `#${uri}`); // Update URL hash without pushing new history
            }
        });

        // Event delegation for internal MDP links
        contentDisplay.addEventListener('click', (e) => {
            const link = e.target.closest('a[data-mdp-link]');
            if (link) {
                e.preventDefault(); // Stop standard navigation
                const uri = link.getAttribute('data-mdp-link');
                navigateMDP(uri);
            }
        });

        // --- Initialization ---

        // Check for hash on initial load (allows users to share MDP links)
        const initialUri = window.location.hash ? window.location.hash.substring(1) : 'markdown://home';
        // Initialize mdpHistory with the correct URI if loading from a hash
        if (initialUri !== 'markdown://home') {
            mdpHistory = [initialUri];
            mdpHistoryIndex = 0;
        }

        navigateMDP(initialUri, false); // Don't push state on initial load

        // Update initial button state
        updateHistoryButtons();
    </script>
</body>
</html>
